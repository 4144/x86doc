<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8"/>
	<link rel="stylesheet" type="text/css" href="style.css"/>
	<title>STI—Set Interrupt Flag</title>
</head>
<body>
<h1 id="sti-set-interrupt-flag">STI—Set Interrupt Flag</h1>
<table>
<tr>
	<td>Opcode*</td>
	<td>Instruction</td>
	<td>Op/En</td>
	<td>64-Bit Mode</td>
	<td>Compat/Leg Mode</td>
	<td>Description</td>
</tr>
<tr>
	<td>FB</td>
	<td>STI</td>
	<td>NP</td>
	<td>Valid</td>
	<td>Valid</td>
	<td>Set interrupt flag; external, maskable interrupts enabled at the end of the next instruction.</td>
</tr>
</table>
<h2 id="instruction-operand-encoding">Instruction Operand Encoding</h2>
<table>
<tr>
	<td>Op/En</td>
	<td>Operand 1</td>
	<td>Operand 2</td>
	<td>Operand 3</td>
	<td>Operand 4</td>
</tr>
<tr>
	<td>NP</td>
	<td>NA</td>
	<td>NA</td>
	<td>NA</td>
	<td>NA</td>
</tr>
</table>
<h2 id="description">Description</h2>
<p>If protected-mode virtual interrupts are not enabled, STI sets the interrupt flag (IF) in the EFLAGS register. After the IF flag is set, the processor begins responding to external, maskable interrupts after the next instruction is executed. The delayed effect of this instruction is provided to allow interrupts to be enabled just before returning from a procedure (or subroutine). For instance, if an STI instruction is followed by an RET instruction, the RET instruction is allowed to execute before external interrupts are recognized1. If the STI instruction is followed by a CLI instruction (which clears the IF flag), the effect of the STI instruction is negated.</p>
<p>The IF flag and the STI and CLI instructions do not prohibit the generation of exceptions and NMI interrupts. NMI interrupts (and SMIs) may be blocked for one macroinstruction following an STI.</p>
<p>When protected-mode virtual interrupts are enabled, CPL is 3, and IOPL is less than 3; STI sets the VIF flag in the EFLAGS register, leaving IF unaffected.</p>
<p>Table 4-15 indicates the action of the STI instruction depending on the processor’s mode of operation and the CPL/IOPL settings of the running program or procedure.</p>
<p>This instruction’s operation is the same in non-64-bit modes and 64-bit mode.</p>
<table>
<tr>
	<td>Table 4-15.</td>
	<td>Decision Table for STI Results</td>
</tr>
<tr>
	<td>CPL</td>
	<td>STI Result</td>
</tr>
<tr>
	<td>X</td>
	<td>IF = 1</td>
</tr>
<tr>
	<td>X</td>
	<td>IF = 1</td>
</tr>
<tr>
	<td>3</td>
	<td>VIF = 1</td>
</tr>
<tr>
	<td>&lt; 3</td>
	<td>GP Fault</td>
</tr>
<tr>
	<td>X</td>
	<td>GP Fault</td>
</tr>
<tr>
	<td>X</td>
	<td>GP Fault</td>
</tr>
<tr>
	<td>X</td>
	<td>IF = 1</td>
</tr>
<tr>
	<td>X</td>
	<td>VIF = 1</td>
</tr>
<tr>
	<td>X</td>
	<td>GP Fault</td>
</tr>
<tr>
	<td>X</td>
	<td>GP Fault</td>
</tr>
</table>
<p class="notes">Notes: X = This setting has no impact.</p>
<table>
<tr>
	<td>1.</td>
	<td>The STI instruction delays recognition of interrupts only if it is executed with EFLAGS.IF = 0. In a sequence of STI instructions, only the first instruction in the sequence is guaranteed to delay interrupts. In the following instruction sequence, interrupts may be recognized before RET executes: STI STI RET</td>
</tr>
</table>
<h2 id="operation">Operation</h2>
<pre>IF PE = 0
  THEN
     IF ← 1; (* Set Interrupt Flag *)
  ELSE
     IF VM = 0
       THEN
          IF IOPL ≥ CPL
             THEN
               IF ← 1;
          ELSE
             IF (IOPL &lt; CPL) and (CPL = 3) and (VIP = 0)
               THEN
                  VIF ← 1;
               ELSE
                  #GP(0);
             FI;
          FI;
       ELSE
          IF IOPL = 3
             THEN
               IF ← 1;
          ELSE
             IF ((IOPL &lt; 3) and (VIP = 0) and (VME = 1))
               THEN
                  VIF ← 1;
             ELSE
               #GP(0); (* Trap to virtual-8086 monitor *)
             FI;)
          FI;
     FI;
FI;
</pre>
<h2 id="flags-affected">Flags Affected</h2>
<p>The IF flag is set to 1; or the VIF flag is set to 1.</p>
<h2 id="protected-mode-exceptions">Protected Mode Exceptions</h2>
<table>
<tr>
	<td>#GP(0)</td>
	<td>If the CPL is greater (has less privilege) than the IOPL of the current program or procedure.</td>
</tr>
<tr>
	<td>#UD</td>
	<td>If the LOCK prefix is used.</td>
</tr>
</table>
<h2 id="real-address-mode-exceptions">Real-Address Mode Exceptions</h2>
<table>
<tr>
	<td>#UD</td>
	<td>If the LOCK prefix is used.</td>
</tr>
</table>
<h2 id="virtual-8086-mode-exceptions">Virtual-8086 Mode Exceptions</h2>
<p>Same exceptions as in protected mode.</p>
<h2 id="compatibility-mode-exceptions">Compatibility Mode Exceptions</h2>
<p>Same exceptions as in protected mode.</p>
<h2 id="64-bit-mode-exceptions">64-Bit Mode Exceptions</h2>
<p>Same exceptions as in protected mode.</p>
</body>
</html>
